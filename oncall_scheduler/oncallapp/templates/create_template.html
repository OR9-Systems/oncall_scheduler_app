{% extends "base.html" %}

{% block content %}
<h1>Create Schedule Template</h1>

<!-- Main container for the calendar -->
<main class="row">
    <div id="ec" class="col"></div>
</main>

<form method="POST" action="{{ url_for('create_template') }}">
    {{ form.hidden_tag() }}

    <div class="form-group">
        {{ form.name.label(class="form-control-label") }}
        {{ form.name(class="form-control") }}
    </div>

    <!-- Group Selection -->
    <div class="form-group">
        {{ form.group.label(class="form-control-label") }}
        {{ form.group(class="form-control") }}
    </div>

    <div class="form-group">
        {{ form.repeat_weekly.label(class="form-check-label") }}
        {{ form.repeat_weekly(class="form-check-input") }}
    </div>

    <div class="form-group">
        {{ form.submit(class="btn btn-primary") }}
    </div>
</form>


<script type="text/javascript">
        function initCalendar(templateId) {
                createEvents(templateId).then(events => {
                    console.log("Events to pass into the calendar:", events);

                    const ec = new EventCalendar(document.getElementById('ec'), {
                        view: 'timeGridWeek',
                        headerToolbar: {
                            start: 'prev,next today',
                            center: 'title',
                            end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek resourceTimeGridWeek,resourceTimelineWeek'
                        },
                        resources: [
                            { id: 1, title: 'Onshore' },
                            { id: 2, title: 'Offshore' }
                        ],
                        scrollTime: '09:00:00',
                        events: events,  // Pass resolved events array here
                        views: {
                            timeGridWeek: { pointer: true },
                            resourceTimeGridWeek: { pointer: true },
                            resourceTimelineWeek: {
                                pointer: true,
                                slotMinTime: '09:00',
                                slotMaxTime: '21:00',
                                slotWidth: 80,
                                resources: [
                                    { id: 1, title: 'Onshore' },
                                    { id: 2, title: 'Offshore' },
                                    { id: 3, title: 'Resource C' },
                                    { id: 4, title: 'Resource D' },
                                    { id: 5, title: 'Resource E' },
                                    { id: 6, title: 'Resource F' },
                                    { id: 7, title: 'Resource G' },
                                    { id: 8, title: 'Resource H' },
                                    { id: 9, title: 'Resource I' },
                                    { id: 10, title: 'Resource J' },
                                    { id: 11, title: 'Resource K' },
                                    { id: 12, title: 'Resource L' },
                                    { id: 13, title: 'Resource M' },
                                    { id: 14, title: 'Resource N' },
                                    { id: 15, title: 'Resource O' }
                                ]
                            }
                        },
                        dayMaxEvents: true,
                        nowIndicator: true,
                        selectable: true,
                        editable: true,
                        eventDrop: function (info) {
                            saveEvent(info.event,templateId);
                        },
                        eventResize: function (info) {
                            saveEvent(info.event,templateId);
                        }
                    });
                }).catch(error => {
                    console.error('Error initializing calendar:', error);
                });
            }

            // Call initCalendar after document is ready
            document.addEventListener('DOMContentLoaded', function () {
                const templateId = `{{ template.id if template else session['template_id'] }}`;
                console.log("Template ID from session:", templateId);
                initCalendar(templateId);  // Initialize calendar with template ID
            });



    // Function to fetch or create events with logging
    function createEvents(templateId) {
        console.log("Fetching events for template ID:", templateId);


         if (!templateId) {
            console.error("No template ID provided. Using default events.");
            return initializeDefaultEvents();
        }


        return fetch(`/load_events/${templateId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                return response.json();
            })
            .then(events => {
                if (events.length === 0) {
                    console.log("No events found, initializing default events.");
                    let defaultEvents = initializeDefaultEvents();

                    // Save default events (optional)
                    defaultEvents.forEach(event => {
                        console.log("Saving default event:", event);
                        saveEvent(event, templateId);
                    });

                    return defaultEvents;
                } else {
                    console.log("Events loaded from the database:", events);
                    return events.map(event => ({
                        id: event.id,
                        start: event.start,
                        end: event.end,
                        resourceId: event.resourceId,
                        title: event.title
                    }));
                }
            })
            .catch(error => {
                console.error('Error loading events:', error);
                // Return default events if the fetch fails
                return initializeDefaultEvents();
            });
    }

    function initializeDefaultEvents(templateId) {
        console.log("Initializing default events...");
        let days = [];
        for (let i = 0; i < 7; ++i) {
            let day = new Date();
            let diff = i - day.getDay();
            day.setDate(day.getDate() + diff);
            days[i] = day.getFullYear() + "-" + _pad(day.getMonth() + 1) + "-" + _pad(day.getDate());
        }

        const defaultEvents = [
            { id: 1, start: days[0] + " 00:00", end: days[0] + " 09:00", resourceId: 1, display: "background", template_id: templateId },
            { id: 2, start: days[1] + " 12:00", end: days[1] + " 14:00", resourceId: 2, display: "background", template_id: templateId },
            { id: 3, start: days[2] + " 17:00", end: days[2] + " 24:00", resourceId: 1, display: "background", template_id: templateId },
            { id: 4, start: days[0] + " 10:00", end: days[0] + " 14:00", resourceId: 1, title: "The calendar can display background and regular events", color: "#FE6B64", template_id: templateId },
            { id: 5, start: days[1] + " 16:00", end: days[2] + " 08:00", resourceId: 2, title: "An event may span to another day", color: "#B29DD9", template_id: templateId },
            { id: 6, start: days[2] + " 09:00", end: days[2] + " 13:00", resourceId: 2, title: "Events can be assigned to resources and the calendar has the resources view built-in", color: "#779ECB", template_id: templateId },
            { id: 7, start: days[3] + " 14:00", end: days[3] + " 20:00", resourceId: 1, title: "", color: "#FE6B64", template_id: templateId },
            { id: 8, start: days[3] + " 15:00", end: days[3] + " 18:00", resourceId: 1, title: "Overlapping events are positioned properly", color: "#779ECB", template_id: templateId },
            { id: 10, start: days[5] + " 14:00", end: days[5] + " 19:00", resourceId: 2, title: "â€¦and you can drag and drop the events!", color: "#FE6B64", template_id: templateId },
            { id: 11, start: days[5] + " 18:00", end: days[5] + " 21:00", resourceId: 2, title: "", color: "#B29DD9", template_id: templateId },
            { id: 12, start: days[1], end: days[3], resourceId: 1, title: "All-day events can be displayed at the top", color: "#B29DD9", allDay: true, template_id: templateId }
        ];

        console.log("Default events initialized:", defaultEvents);

        // Save each event to the backend
        defaultEvents.forEach(event => {
            saveEvent(event, templateId);
        });

        return defaultEvents;
    }


    
         // Function to save an event to the backend
            function saveEvent(event, templateId) {
                let startDate = typeof event.start === 'string' ? new Date(event.start) : event.start;
                let endDate = typeof event.end === 'string' ? new Date(event.end) : event.end;
                const resourceId = event.resourceId ? event.resourceId : null;


                 // UTC to Non Utc Conversion 

                 startDate.setHours(startDate.getHours() - 4);
                if (endDate) {
                    endDate.setHours(endDate.getHours() - 4);
                }


                const eventData = {
                    id: event.id,
                    title: event.title || '',
                    start: startDate.toISOString(),
                    end: endDate ? endDate.toISOString() : null,
                    resourceId: resourceId,
                    template_id: templateId
                };

                console.log("Saving event to the backend:", eventData);

                fetch('{{ url_for("save_event") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ form.csrf_token._value() }}'
                    },
                    body: JSON.stringify(eventData)
                }).then(response => {
                    return response.json().then(data => {
                        if (!response.ok) {
                            console.error('Failed to save event:', data.message);
                            alert('Failed to save event: ' + data.message);
                        } else {
                            console.log("Event saved successfully:", data);
                            if (!event.id) {
                                event.id = data.event_id;  // Update new event's id
                            }
                        }
                    });
                }).catch(error => {
                    console.error('Error during event saving:', error);
                });
            }

    // Helper function to pad numbers (for date formatting)
    function _pad(num) {
        let norm = Math.floor(Math.abs(num));
        return (norm < 10 ? '0' : '') + norm;
    }
</script>

<style>
    /* Override Bootstrap's font size for event titles */
    .ec-event-title {
        font-size: inherit !important;
    }
</style>


{% endblock %}